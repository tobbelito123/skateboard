<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Mobile-optimized viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mobile Loot & Dodge â€“ Enhanced</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      background: #111;
      color: #fff;
      font-family: sans-serif;
      /* Disable default touch actions */
      touch-action: none;
    }
    /* Fullscreen canvas */
    #gameCanvas {
      display: block;
      background: #222;
      /* Disable default touch actions on canvas too */
      touch-action: none;
    }
    /* Fixed scoreboard */
    #scoreboard {
      position: fixed;
      top: 5px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      font-size: 1.2em;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 5px;
    }
    /* Message overlay */
    #message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
      font-size: 2em;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    /* Shoot Button styling */
    #shootBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 30;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background-color: rgba(255, 255, 255, 0.8);
      font-size: 16px;
      font-weight: bold;
      color: #111;
      outline: none;
      cursor: pointer;
      box-shadow: 0px 4px 6px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="scoreboard">Score: 0 | High Score: 0 | Lives: 3</div>
  <div id="message"></div>
  <button id="shootBtn">SHOOT</button>
  <script>
    // ========= Global Variables and Canvas Setup =========
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // Resize canvas to full window size
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      if (player) {
        player.y = canvas.height - 60;
      }
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // ========= Game State Variables =========
    let lastTime = 0;
    let enemySpawnTimer = 0;
    let lootSpawnTimer = 0;
    let gameOver = false;

    // Score and lives
    let score = 0;
    let lives = 3;
    let highScore = Number(localStorage.getItem("highScore")) || 0;

    // Power-up timers (in ms)
    let shieldTimer = 0;
    let doubleScoreTimer = 0;
    let slowTimeTimer = 0;
    let scoreMultiplier = 1;
    let enemySpeedMultiplier = 1;

    // ========= Player Object =========
    const player = {
      x: canvas.width / 2,
      y: canvas.height - 60,
      width: 40,
      height: 40,
      draw() {
        ctx.save();
        ctx.fillStyle = shieldTimer > 0 ? "#0ff" : "#0f0";
        ctx.beginPath();
        ctx.moveTo(this.x, this.y - this.height / 2);
        ctx.lineTo(this.x - this.width / 2, this.y + this.height / 2);
        ctx.lineTo(this.x + this.width / 2, this.y + this.height / 2);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
      }
    };

    // ========= Arrays for Enemies, Loot Boxes, and Bullets =========
    const enemies = [];
    const lootBoxes = [];
    const bullets = [];

    // ========= Reward Options for Loot Boxes =========
    const rewards = [
      {
        name: "Extra Points",
        effect: function() {
          score += 50;
          displayMessage("+50 Points!");
        }
      },
      {
        name: "Shield",
        effect: function() {
          shieldTimer = 5000;
          displayMessage("Shield Activated!");
        }
      },
      {
        name: "Double Score",
        effect: function() {
          scoreMultiplier = 2;
          doubleScoreTimer = 10000;
          displayMessage("Double Score!");
        }
      },
      {
        name: "Slow Time",
        effect: function() {
          enemySpeedMultiplier = 0.5;
          slowTimeTimer = 5000;
          displayMessage("Slow Time!");
        }
      },
      {
        name: "Extra Life",
        effect: function() {
          if (lives < 5) {
            lives++;
            displayMessage("Extra Life!");
          } else {
            displayMessage("Max Lives!");
          }
        }
      }
    ];

    // ========= Utility Functions =========
    function rectsIntersect(a, b) {
      return !(a.x > b.x + b.width ||
               a.x + a.width < b.x ||
               a.y > b.y + b.height ||
               a.y + a.height < b.y);
    }

    function displayMessage(text) {
      const msgEl = document.getElementById("message");
      msgEl.textContent = text;
      msgEl.style.opacity = 1;
      setTimeout(() => { msgEl.style.opacity = 0; }, 1500);
    }

    function updateScoreboard() {
      document.getElementById("scoreboard").innerHTML =
        "Score: " + Math.floor(score) +
        " | High Score: " + Math.floor(highScore) +
        " | Lives: " + lives;
    }

    // ========= Touch Controls for Moving the Ship =========
    function handleTouch(evt) {
      evt.preventDefault();
      if (evt.touches.length > 0) {
        const touch = evt.touches[0];
        const rect = canvas.getBoundingClientRect();
        const touchX = touch.clientX - rect.left;
        if (gameOver) {
          restartGame();
          return;
        }
        // Clamp player's position within screen bounds.
        player.x = Math.max(player.width / 2, Math.min(canvas.width - player.width / 2, touchX));
      }
    }
    canvas.addEventListener("touchstart", handleTouch, {passive: false});
    canvas.addEventListener("touchmove", handleTouch, {passive: false});

    // ========= Enemy and LootBox Constructors =========
    function createEnemy() {
      const size = 30;
      const x = Math.random() * (canvas.width - size);
      const y = -size;
      const speed = 200 + Math.random() * 100;
      enemies.push({ x, y, width: size, height: size, speed });
    }

    function createLootBox() {
      const size = 25;
      const x = Math.random() * (canvas.width - size);
      const y = -size;
      const speed = 150 + Math.random() * 50;
      lootBoxes.push({ x, y, width: size, height: size, speed });
    }

    // ========= Bullet Constructor and Shooting Function =========
    function shootBullet() {
      // Create a bullet starting from the player's top-center.
      const bulletWidth = 5;
      const bulletHeight = 10;
      const bulletSpeed = 500; // upward speed in pixels per second
      bullets.push({
        x: player.x - bulletWidth / 2,
        y: player.y - player.height / 2,
        width: bulletWidth,
        height: bulletHeight,
        speed: bulletSpeed
      });
    }

    // Attach event to the shoot button.
    document.getElementById("shootBtn").addEventListener("touchstart", (evt) => {
      evt.preventDefault();
      if (!gameOver) shootBullet();
    }, {passive: false});
    document.getElementById("shootBtn").addEventListener("click", (evt) => {
      evt.preventDefault();
      if (!gameOver) shootBullet();
    });

    // ========= Game Loop =========
    function gameLoop(timestamp) {
      if (!lastTime) lastTime = timestamp;
      const deltaTime = timestamp - lastTime;
      lastTime = timestamp;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Increase score gradually with multiplier.
      score += (deltaTime / 100) * scoreMultiplier;

      // Update power-up timers.
      if (shieldTimer > 0) { shieldTimer -= deltaTime; if (shieldTimer < 0) shieldTimer = 0; }
      if (doubleScoreTimer > 0) { 
        doubleScoreTimer -= deltaTime; 
        if (doubleScoreTimer <= 0) { doubleScoreTimer = 0; scoreMultiplier = 1; }
      }
      if (slowTimeTimer > 0) { 
        slowTimeTimer -= deltaTime; 
        if (slowTimeTimer <= 0) { slowTimeTimer = 0; enemySpeedMultiplier = 1; }
      }

      // Spawn enemies.
      enemySpawnTimer += deltaTime;
      if (enemySpawnTimer > 800 + Math.random() * 200) {
        createEnemy();
        enemySpawnTimer = 0;
      }
      // Spawn loot boxes.
      lootSpawnTimer += deltaTime;
      if (lootSpawnTimer > 6000 + Math.random() * 2000) {
        createLootBox();
        lootSpawnTimer = 0;
      }

      // Update and draw enemies.
      for (let i = enemies.length - 1; i >= 0; i--) {
        const enemy = enemies[i];
        enemy.y += enemy.speed * enemySpeedMultiplier * (deltaTime / 1000);
        ctx.fillStyle = "#f00";
        ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
        if (enemy.y > canvas.height) {
          enemies.splice(i, 1);
          continue;
        }
        // Check collision with player.
        if (rectsIntersect(enemy, {
          x: player.x - player.width / 2,
          y: player.y - player.height / 2,
          width: player.width,
          height: player.height
        })) {
          if (shieldTimer > 0) {
            shieldTimer = 0;
            enemies.splice(i, 1);
            displayMessage("Shield saved you!");
          } else {
            lives--;
            enemies.splice(i, 1);
            displayMessage("Ouch!");
            if (lives <= 0) { endGame(); }
          }
        }
      }

      // Update and draw loot boxes.
      for (let i = lootBoxes.length - 1; i >= 0; i--) {
        const loot = lootBoxes[i];
        loot.y += loot.speed * (deltaTime / 1000);
        ctx.fillStyle = "#00f";
        ctx.fillRect(loot.x, loot.y, loot.width, loot.height);
        if (loot.y > canvas.height) {
          lootBoxes.splice(i, 1);
          continue;
        }
        // Check collision with player.
        if (rectsIntersect(loot, {
          x: player.x - player.width / 2,
          y: player.y - player.height / 2,
          width: player.width,
          height: player.height
        })) {
          const reward = rewards[Math.floor(Math.random() * rewards.length)];
          reward.effect();
          lootBoxes.splice(i, 1);
        }
      }

      // Update and draw bullets.
      for (let i = bullets.length - 1; i >= 0; i--) {
        const bullet = bullets[i];
        bullet.y -= bullet.speed * (deltaTime / 1000);
        ctx.fillStyle = "#ff0";
        ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
        if (bullet.y + bullet.height < 0) {
          bullets.splice(i, 1);
          continue;
        }
        // Check collision with enemies.
        for (let j = enemies.length - 1; j >= 0; j--) {
          if (rectsIntersect(bullet, enemies[j])) {
            // Enemy hit by bullet.
            enemies.splice(j, 1);
            bullets.splice(i, 1);
            score += 100;
            displayMessage("+100!");
            break;
          }
        }
      }

      // Draw the player ship.
      player.draw();

      // Update scoreboard and high score.
      if (score > highScore) {
        highScore = score;
        localStorage.setItem("highScore", Math.floor(highScore));
      }
      updateScoreboard();

      if (gameOver) {
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#fff";
        ctx.font = "bold 36px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2 - 20);
        ctx.font = "24px sans-serif";
        ctx.fillText("Tap to Restart", canvas.width / 2, canvas.height / 2 + 20);
        return;
      }

      requestAnimationFrame(gameLoop);
    }

    // ========= End and Restart Game =========
    function endGame() {
      gameOver = true;
      displayMessage("Game Over!");
    }

    function restartGame() {
      score = 0;
      lives = 3;
      shieldTimer = 0;
      doubleScoreTimer = 0;
      slowTimeTimer = 0;
      scoreMultiplier = 1;
      enemySpeedMultiplier = 1;
      enemies.length = 0;
      lootBoxes.length = 0;
      bullets.length = 0;
      enemySpawnTimer = 0;
      lootSpawnTimer = 0;
      gameOver = false;
      lastTime = 0;
      player.x = canvas.width / 2;
      player.y = canvas.height - 60;
      requestAnimationFrame(gameLoop);
    }

    // ========= Start the Game =========
    requestAnimationFrame(gameLoop);
    canvas.addEventListener("touchend", () => { if (gameOver) restartGame(); });
    canvas.addEventListener("mousedown", () => { if (gameOver) restartGame(); });
  </script>
</body>
</html>
