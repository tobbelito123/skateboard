<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="utf-8">
    <title>Plattformsspel med Boss, Pistol/Shotgun, m.m.</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #87CEFA;
            overflow: hidden;
        }
        .info {
            text-align: center;
            font-family: sans-serif;
            margin-top: 10px;
        }
    </style>
  <meta charset="UTF-8" />
  <title>Skateboard Shooter</title>
  <!-- Laddar Pixi.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@7/dist/browser/pixi.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #333;
      overflow: hidden; /* Dölj scrollbars */
    }
    #game-container {
      /* Pixi kommer att injicera sin canvas här */
      width: 100vw;
      height: 100vh;
    }
    .hud {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #fff;
      font-family: sans-serif;
      font-size: 20px;
    }
  </style>
</head>
<body>
    <div class="info">
        <p>
            <strong>Styrning:</strong> Vänster/Höger-pil för rörelse, Uppåtpil för dubbelhopp (max 2).<br>
            Space för att skjuta. Level 1 = pistol (1 skott), Level 2+ = shotgun (10 skott spridning).<br>
            100 skott innan omladdning (2 sek). Boss (grön-svart-randig) spawnar efter 15 svarta/gröna fiender dödats.<br>
            På kollision: spelaren -20 HP, boss studsar bort. När boss dör → Level up direkt.
        </p>
    </div>
    <canvas id="gameCanvas" width="1200" height="600"></canvas>
    <script>
        // =========================================
        //  Konstanter och variabler
        // =========================================
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const CANVAS_WIDTH = canvas.width;
        const CANVAS_HEIGHT = canvas.height;
        let WORLD_WIDTH = 4000;
        let WORLD_HEIGHT = 600;
        // Kamera
        let cameraX = 0;
        // Spelare
        let player = {
            x: 100,
            y: 300,
            width: 32,
            height: 32,
            vx: 0,
            vy: 0,
            speed: 2,
            onGround: false
        };
        let lastDirection = +1; // +1 höger, -1 vänster
        // HP, poäng, level
        let health = 100;
        let score = 0;
        let level = 1;
        // Dubbelhopp
        let jumpCount = 0;
        const MAX_JUMPS = 2;
        // Fysik
        const GRAVITY = 0.4;
        const FRICTION = 0.8;
        const JUMP_FORCE = 10;
        const MAX_VELOCITY = 8;
        // Skott / omladdning
        let bulletShots = 0;
        let isReloading = false;
        const RELOAD_TIME = 2000;
        const BULLET_SPEED = MAX_VELOCITY * 2; // 16
        // Fiender, plattformar, skott, perks, effekter
        let platforms = [];
        let enemies = [];
        let bullets = [];
        let perks = [];
        let deathEffects = [];
        // Koll på hur många **svarta+gröna** fiender dödats total (för boss-trigg)
        let blackGreenKills = 0;
        // True om boss redan spawnats denna level
        let bossSpawned = false;
        // Tangentbord
        let keys = {
            left: false,
            right: false,
            up: false,
            space: false
        };
        // =========================================
        //  Tangentbord
        // =========================================
        document.addEventListener("keydown", (e) => {
            if (e.code === "ArrowLeft") { lastDirection = -1; keys.left = true; }
            if (e.code === "ArrowRight") { lastDirection = +1; keys.right = true; }
            if (e.code === "ArrowUp") { keys.up = true; }
            if (e.code === "Space") { keys.space = true; }
        });
        document.addEventListener("keyup", (e) => {
            if (e.code === "ArrowLeft") { keys.left = false; }
            if (e.code === "ArrowRight") { keys.right = false; }
            if (e.code === "ArrowUp") { keys.up = false; }
            if (e.code === "Space") { keys.space = false; }
        });
        // =========================================
        //  Starta
        // =========================================
        initLevel(level);
        requestAnimationFrame(gameLoop);
        // =========================================
        //  gameLoop
        // =========================================
        function gameLoop() {
            update();
            draw();
            if (health > 0) {
                requestAnimationFrame(gameLoop);
            } else {
                gameOver();
            }
  <div id="game-container"></div>
  <div class="hud" id="hp">HP: 100</div>
  
  <script>
    // === Skapa Pixi-applikation ===
    const app = new PIXI.Application({
      width: window.innerWidth,
      height: window.innerHeight,
      backgroundColor: 0x1099bb,
      antialias: true,
    });
    document.getElementById('game-container').appendChild(app.view);
    // === Konstanter för spelet ===
    const PLAYER_SPEED = 5;         // Hastighet när spelaren rör sig med piltangenter
    const BULLET_SPEED = 10;        // Hastighet för kulor
    const ENEMY_SPEED = 4;          // Hastighet för fiender
    const ENEMY_SPAWN_INTERVAL = 60; // Bildrutor mellan fiendespawns
    const PLAYER_MAX_HP = 100;
    // === Variabler och containers ===
    let keys = {};                  // Tangenttryck
    let playerHP = PLAYER_MAX_HP;
    let enemySpawnCounter = 0;      // Räknare för när vi ska spawna fiender
    
    // Sprites/Containers
    const bullets = [];             // Array för spelarens kulor
    const enemyBullets = [];        // Array för fiendens kulor
    const enemies = [];             // Array för fiender
    
    // === Skapa en bakgrund som "scrollar" ===
    // Vi kan använda en TilingSprite för att simulera rörelse.
    const textureBG = PIXI.Texture.WHITE; // En vit ruta
    const background = new PIXI.TilingSprite(
      textureBG,
      app.screen.width,
      app.screen.height
    );
    background.tint = 0x333333; // Mörkare färg
    app.stage.addChild(background);
    // === Spelar-sprite (en enkel rektangel i Pixi) ===
    const player = new PIXI.Graphics();
    player.beginFill(0x00ff00);
    player.drawRect(-25, -50, 50, 100); // En rektangel, centrerad
    player.endFill();
    player.x = app.screen.width / 2;
    player.y = app.screen.height - 150; // Längre ner på skärmen
    app.stage.addChild(player);
    // === Huvud-loop (ticker) i Pixi ===
    app.ticker.add((delta) => {
      // 1. Uppdatera bakgrundens "tiles" för att få scroll-effekt
      background.tilePosition.y += 2;
      // 2. Läs av tangenttryck och styr spelaren
      handlePlayerMovement();
      // 3. Uppdatera alla kulor (både spelarens och fiendernas)
      updateBullets();
      // 4. Spawna fiender med ett intervall
      spawnEnemies();
      // 5. Uppdatera fiender och kolla kollisioner
      updateEnemies();
      // 6. Uppdatera HUD (HP)
      document.getElementById('hp').innerText = `HP: ${playerHP}`;
      // 7. Kolla om spelaren dött
      if (playerHP <= 0) {
        gameOver();
      }
    });
    // === Hantera tangenttryckning (piltangenter & space) ===
    window.addEventListener("keydown", (e) => {
      keys[e.code] = true;
      // Om space trycks, skjut kula
      if (e.code === "Space") {
        shootBullet();
      }
    });
    window.addEventListener("keyup", (e) => {
      keys[e.code] = false;
    });
    // === Flytta spelaren baserat på vilka tangenter som är nedtryckta ===
    function handlePlayerMovement() {
      // Vänster/Höger
      if (keys["ArrowLeft"]) {
        player.x -= PLAYER_SPEED;
      } else if (keys["ArrowRight"]) {
        player.x += PLAYER_SPEED;
      }
      // Upp/Ner
      if (keys["ArrowUp"]) {
        player.y -= PLAYER_SPEED;
      } else if (keys["ArrowDown"]) {
        player.y += PLAYER_SPEED;
      }
      // Begränsa spelaren inom skärmens gränser
      if (player.x < 0) player.x = 0;
      if (player.x > app.screen.width) player.x = app.screen.width;
      if (player.y < 0) player.y = 0;
      if (player.y > app.screen.height) player.y = app.screen.height;
    }
    // === Spelaren skjuter en kula ===
    function shootBullet() {
      const bullet = new PIXI.Graphics();
      bullet.beginFill(0xffff00);
      bullet.drawCircle(0, 0, 5);
      bullet.endFill();
      bullet.x = player.x;
      bullet.y = player.y - 50; // Precis framför spelaren
      app.stage.addChild(bullet);
      bullets.push(bullet);
    }
    // === Uppdatera position för kulor och ta bort dem om de är utanför skärmen ===
    function updateBullets() {
      // Spelarens kulor
      for (let i = bullets.length - 1; i >= 0; i--) {
        bullets[i].y -= BULLET_SPEED;
        if (bullets[i].y < 0) {
          app.stage.removeChild(bullets[i]);
          bullets.splice(i, 1);
        }
        // =========================================
        //  update(): spel-logik
        // =========================================
        function update() {
            // Spelare
            if (keys.left) player.vx -= player.speed;
            if (keys.right) player.vx += player.speed;
            if (keys.up && jumpCount < MAX_JUMPS) {
                player.vy = -JUMP_FORCE;
                jumpCount++;
                keys.up = false;
                player.onGround = false;
            }
            // Skjuta
            if (keys.space && !isReloading) {
                // Kolla om Level <2 => pistol (1 skott)
                // Level >=2 => shotgun (10 skott i spridning)
                if (level < 2) {
                    fireOneBullet();
                } else {
                    // shotgun
                    fireShotgun();
                }
                keys.space = false;
            }
            // Gravitation
            player.vy += GRAVITY;
            if (player.onGround) player.vx *= FRICTION;
            if (player.vx > MAX_VELOCITY) player.vx = MAX_VELOCITY;
            if (player.vx < -MAX_VELOCITY) player.vx = -MAX_VELOCITY;
            player.x += player.vx;
            player.y += player.vy;
            // Begränsa spelaren
            if (player.x < 0) { player.x = 0; player.vx = 0; }
            if (player.x + player.width > WORLD_WIDTH) {
                player.x = WORLD_WIDTH - player.width;
                player.vx = 0;
            }
            if (player.y + player.height > WORLD_HEIGHT) {
                player.y = WORLD_HEIGHT - player.height;
                player.vy = 0; player.onGround = true; jumpCount = 0;
            }
            // Plattformar (spelaren)
            player.onGround = false;
            for (let plat of platforms) {
                if (checkCollision(player, plat)) {
                    if (player.vy > 0) {
                        player.y = plat.y - player.height;
                        player.vy = 0; player.onGround = true; jumpCount = 0;
                    }
                }
            }
            // Fiender
            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                // Jagar i x-led
                if (e.x < player.x) e.vx = e.speed;
                else e.vx = - e.speed;
                // slump-hopp
                if (e.onGround && Math.random() < 0.003) {
                    e.vy = -JUMP_FORCE;
                    e.onGround = false;
                }
                e.vy += GRAVITY;
                e.x += e.vx;
                e.y += e.vy;
                // Begränsa fiende
                if (e.x < 0) e.x = 0;
                if (e.x + e.width > WORLD_WIDTH) {
                    e.x = WORLD_WIDTH - e.width;
                }
                if (e.y + e.height > WORLD_HEIGHT) {
                    e.y = WORLD_HEIGHT - e.height;
                    e.vy = 0;
                    e.onGround = true;
                }
                // fiende -> plattform
                e.onGround = false;
                for (let plat of platforms) {
                    if (checkCollision(e, plat)) {
                        if (e.vy > 0) {
                            e.y = plat.y - e.height;
                            e.vy = 0; e.onGround = true;
                        }
                    }
                }
                // fiende -> spelare
                // Om boss: spelare -20 HP, boss studsar lite, men boss dör ej
                // Vanlig fiende: - tar HP? etc.
                if (checkCollision(e, player)) {
                    if (e.isBoss) {
                        // Boss kollision
                        health -= 20;
                        // boss studsar bort
                        e.vx = (e.x < player.x ? -10 : 10);
                    } else {
                        // Vanlig fiende => spelare tar skada, fiende dör
                        health -= e.damage;
                        enemies.splice(i, 1);
                        createDeathEffect(e.x + e.width / 2, e.y + e.height / 2, e.color, e.isBoss);
                        spawnOneEnemyIfNotBoss(e.isBoss);
                    }
                }
            }
            // Bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                b.x += b.vx;
                if (b.x < -200 || b.x > WORLD_WIDTH + 200) {
                    bullets.splice(i, 1);
                    continue;
                }
                // bullet -> fiende
                for (let j = enemies.length - 1; j >= 0; j--) {
                    let e = enemies[j];
                    if (checkCollision(b, e)) {
                        e.hp -= b.damage;
                        bullets.splice(i, 1);
                        if (e.hp <= 0) {
                            // fienden dör
                            score += e.scoreValue;
                            // Öka blackGreenKills om e har black/green color
                            if (e.isBlackOrGreen) blackGreenKills++;
                            // Om boss => leveln byts direkt
                            if (e.isBoss) {
                                // Rensa fienden
                                enemies.splice(j, 1);
                                createDeathEffect(e.x + e.width / 2, e.y + e.height / 2, e.color, e.isBoss);
                                // Byt level direkt
                                level++;
                                initLevel(level);
                            } else {
                                enemies.splice(j, 1);
                                createDeathEffect(e.x + e.width / 2, e.y + e.height / 2, e.color, e.isBoss);
                                spawnOneEnemyIfNotBoss(e.isBoss);
                            }
                            checkSpawnBoss(); // kolla om 15 black/green dödats => spawn boss?
                            checkLevelUp();
                        }
                        break;
                    }
                }
            }
            // Perks
            for (let i = perks.length - 1; i >= 0; i--) {
                let p = perks[i];
                if (checkCollision(player, p)) {
                    health += 20; if (health > 100) health = 100;
                    perks.splice(i, 1);
                }
            }
            // DeathEffects
            for (let i = deathEffects.length - 1; i >= 0; i--) {
                let fx = deathEffects[i];
                fx.radius += fx.growth;
                fx.alpha -= fx.fadeSpeed;
                if (fx.alpha <= 0) {
                    deathEffects.splice(i, 1);
                }
            }
            // uppdatera kamera
            updateCamera();
            // HP <= 0 => gameOver
      }
      // Fienders kulor
      for (let i = enemyBullets.length - 1; i >= 0; i--) {
        enemyBullets[i].y += BULLET_SPEED * 0.8; // Fiendens kulor kan vara lite långsammare
        // Om fiendekulan träffar spelaren
        if (hitTest(enemyBullets[i], player)) {
          playerHP -= 10;
          removeEnemyBullet(i);
          continue; // Hoppa över resten av loopen
        }
        // ======================================
        //  draw(): ritar i Canvas
        // ======================================
        function draw() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            // plattformar (bruna rekt)
            ctx.fillStyle = "#654321";
            for (let plat of platforms) {
                let sx = plat.x - cameraX;
                ctx.fillRect(sx, plat.y, plat.width, plat.height);
            }
            // fiender
            for (let e of enemies) {
                let sx = e.x - cameraX + e.width / 2;
                let sy = e.y + e.height / 2;
                // Om boss => rita stor "grönsvart-randig" cirkel
                if (e.isBoss) {
                    drawStripedCircle(sx, sy, e.width / 2);
                } else {
                    // vanlig fiende
                    drawCircle(sx, sy, e.width / 2, e.color);
                }
            }
            // perks (grön plus)
            for (let p of perks) {
                let sx = p.x - cameraX;
                drawPlus(sx, p.y, p.width, p.height, "#00ff00");
            }
            // bullets (gul)
            for (let b of bullets) {
                let sx = b.x - cameraX + b.width / 2;
                let sy = b.y + b.height / 2;
                drawCircle(sx, sy, b.width / 2, "#ffff00");
            }
            // spelare (röd cirkel) med pistol
            let px = player.x - cameraX + player.width / 2;
            let py = player.y + player.height / 2;
            // rita kropp
            drawCircle(px, py, player.width / 2, "#ff0000");
            // rita pistol som liten rektangel på höger/vänster sida
            drawPistol(px, py, lastDirection);
            // deathEffects
            for (let fx of deathEffects) {
                ctx.save();
                ctx.globalAlpha = fx.alpha;
                for (let c = 0; c < fx.circleCount; c++) {
                    let angle = (Math.PI * 2 / fx.circleCount) * c;
                    let cx = fx.x + Math.cos(angle) * fx.radius;
                    let cy = fx.y + Math.sin(angle) * fx.radius;
                    let rad = fx.isBoss ? 8 : 5;
                    drawCircle(cx - cameraX, cy, rad, fx.color);
                }
                ctx.restore();
            }
            // HUD
            ctx.fillStyle = "#000000";
            ctx.font = "20px sans-serif";
            ctx.fillText("HP: " + health, 20, 30);
            ctx.fillText("Score: " + score, 20, 60);
            ctx.fillText("Level: " + level, 20, 90);
            ctx.fillText("Black/Green kills: " + blackGreenKills, 20, 120);
            if (isReloading) {
                ctx.fillStyle = "orange";
                ctx.fillText("Laddar om...", 20, 150);
            }
        // Ta bort kula om den är utanför skärmen
        if (enemyBullets[i].y > app.screen.height) {
          removeEnemyBullet(i);
        }
        // ======================================
        //  drawCircle
        // ======================================
        function drawCircle(x, y, r, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fill();
        }
        // ======================================
        //  drawPlus
        // ======================================
        function drawPlus(x, y, w, h, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x + w * 0.4, y, w * 0.2, h);
            ctx.fillRect(x, y + h * 0.4, w, h * 0.2);
        }
        // ======================================
        //  drawStripedCircle (för boss)
        //  ex. randig grön-svart
        // ======================================
        function drawStripedCircle(cx, cy, r) {
            // Låt oss rita en cirkel med ränder
            // T.ex. 6 ränder varannan grön/svart
            let numStripes = 6;
            for (let i = 0; i < numStripes; i++) {
                let startAngle = (Math.PI * 2 / numStripes) * i;
                let endAngle = startAngle + (Math.PI * 2 / numStripes);
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.arc(cx, cy, r, startAngle, endAngle);
                // varannan rand = grön (0x00ff00), varannan svart (#000)
                ctx.fillStyle = (i % 2 === 0) ? "#00ff00" : "#000000";
                ctx.fill();
            }
        }
        // ======================================
        //  drawPistol(px,py,lastDir)
        //  Ritar en liten rektangel på sidan av spelarens cirkel
        // ======================================
        function drawPistol(px, py, dir) {
            // Låt pistolens bredd=8, höjd=4
            let w = 8, h = 4;
            // Om dir= +1 => pistol åt höger, dir=-1 => åt vänster
            let offsetX = (dir > 0) ? +12 : -12 - w;
            let offsetY = -2;
            ctx.fillStyle = "#333333";
            ctx.fillRect(px + offsetX, py + offsetY, w, h);
      }
    }
    // === Hjälpfunktion för att ta bort fiende-kula ===
    function removeEnemyBullet(index) {
      app.stage.removeChild(enemyBullets[index]);
      enemyBullets.splice(index, 1);
    }
    // === Spawna fiender med ett intervall ===
    function spawnEnemies() {
      enemySpawnCounter++;
      if (enemySpawnCounter > ENEMY_SPAWN_INTERVAL) {
        enemySpawnCounter = 0;
        createEnemy();
      }
    }
    // === Skapa en fiende (en enkel röd rektangel) ===
    function createEnemy() {
      const enemy = new PIXI.Graphics();
      enemy.beginFill(0xff0000);
      enemy.drawRect(-25, -50, 50, 100);
      enemy.endFill();
      enemy.x = Math.random() * (app.screen.width - 50) + 25;
      enemy.y = -50; // Börja strax ovanför skärmen
      enemy.hp = 20; // Fiende-HP
      app.stage.addChild(enemy);
      enemies.push(enemy);
    }
    // === Uppdatera fiender, kolla kollisioner, låt fiender skjuta ===
    function updateEnemies() {
      for (let i = enemies.length - 1; i >= 0; i--) {
        const enemy = enemies[i];
        enemy.y += ENEMY_SPEED;
        // Låt fienden skjuta slumpmässigt
        if (Math.random() < 0.01) {
          shootEnemyBullet(enemy);
        }

        // ======================================
        //  createDeathEffect(cx,cy,color,isBoss)
        // ======================================
        function createDeathEffect(cx, cy, color, isBoss) {
            let effect = {
                x: cx,
                y: cy,
                color: color || "#000000",
                radius: 0,
                growth: isBoss ? 2.5 : 1.5,
                alpha: 1.0,
                fadeSpeed: 0.02,
                circleCount: isBoss ? 14 : 6,
                isBoss: isBoss
            };
            deathEffects.push(effect);
        }
        // ======================================
        //  checkCollision(a,b): AABB
        // ======================================
        function checkCollision(a, b) {
            return (
                a.x < b.x + b.width &&
                a.x + a.width > b.x &&
                a.y < b.y + b.height &&
                a.y + a.height > b.y
            );
        }
        // ======================================
        //  updateCamera
        // ======================================
        function updateCamera() {
            cameraX = player.x - CANVAS_WIDTH / 2;
            if (cameraX < 0) cameraX = 0;
            if (cameraX > WORLD_WIDTH - CANVAS_WIDTH) {
                cameraX = WORLD_WIDTH - CANVAS_WIDTH;
        // Kolla om fienden krockar med en av spelarens kulor
        for (let j = bullets.length - 1; j >= 0; j--) {
          if (hitTest(bullets[j], enemy)) {
            enemy.hp -= 10; // Fienden tar skada
            // Ta bort kulan
            app.stage.removeChild(bullets[j]);
            bullets.splice(j, 1);
            // Om fienden dör
            if (enemy.hp <= 0) {
              app.stage.removeChild(enemy);
              enemies.splice(i, 1);
            }
            break; // Avbryt loopen för kulorna
          }
        }

        // ======================================
        //  fireOneBullet()
        //  1 skott (pistol)
        // Skott utgår från pistolens mynning
        // ======================================
        function fireOneBullet() {
            bulletShots++;
            if (bulletShots >= 100) startReload();
            let dmg = 1 + (level - 1) * 2;
            // Hitta pistolens position
            let muzzle = getPistolMuzzle();
            let b = {
                x: muzzle.x - 4,
                y: muzzle.y - 4,
                width: 8, height: 8,
                vx: BULLET_SPEED * lastDirection,
                damage: dmg
            };
            bullets.push(b);
        // Om fienden går utanför skärmen, ta bort den
        if (enemy.y > app.screen.height + 100) {
          app.stage.removeChild(enemy);
          enemies.splice(i, 1);
        }
        // ======================================
        //  fireShotgun()
        //  10 skott i spridning
        // ======================================
        function fireShotgun() {
            bulletShots += 10;
            if (bulletShots >= 100) startReload();
            let dmg = 1 + (level - 1) * 2;
            let muzzle = getPistolMuzzle();
            // 10 skott med små vinklar runt lastDirection
            // ex. -15 till +15 grader
            for (let i = 0; i < 10; i++) {
                let spreadAngle = -15 + (30 / 9) * i;
                // om lastDirection<0, spegla
                let rad = (spreadAngle * Math.PI) / 180;
                let vx = BULLET_SPEED * Math.cos(rad) * lastDirection;
                let vy = BULLET_SPEED * 0.2 * Math.sin(rad);
                let b = {
                    x: muzzle.x - 4,
                    y: muzzle.y - 4,
                    width: 8, height: 8,
                    vx: vx,
                    vy: vy || 0,
                    damage: dmg
                };
                bullets.push(b);
            }
        }
        // ======================================
        // getPistolMuzzle()
        //  Returnerar "pistolmynningskoordinater"
        // ======================================
        function getPistolMuzzle() {
            // spelarens center
            let px = player.x + player.width / 2;
            let py = player.y + player.height / 2;
            // pistoloffset ~ (12, -2) om lastdir>0
            // om lastdir<0 => ( -12 - w, -2 )
            let muzzleX = (lastDirection > 0) ? px + 12 : px - 12;
            let muzzleY = py - 2;
            return { x: muzzleX, y: muzzleY };
        }
        // ======================================
        //  startReload
        // ======================================
        function startReload() {
            isReloading = true;
            setTimeout(() => {
                isReloading = false;
                bulletShots = 0;
            }, RELOAD_TIME);
        }
        // ======================================
        //  initLevel(lvl)
        // ======================================
        function initLevel(lvl) {
            WORLD_WIDTH = 4000 + (lvl - 1) * 1000;
            platforms = []; enemies = []; bullets = []; perks = []; deathEffects = [];
            blackGreenKills = 0;
            bossSpawned = false;
            // Spelare i start
            player.x = 100; player.y = 300; player.vx = 0; player.vy = 0; jumpCount = 0;
            // Lite plattformar
            platforms.push({ x: 0, y: 570, width: WORLD_WIDTH, height: 30 });
            platforms.push({ x: 300, y: 450, width: 180, height: 15 });
            platforms.push({ x: 800, y: 350, width: 180, height: 15 });
            platforms.push({ x: 1200, y: 500, width: 150, height: 15 });
            platforms.push({ x: 1700, y: 400, width: 150, height: 15 });
            platforms.push({ x: 2200, y: 300, width: 200, height: 15 });
            platforms.push({ x: 2800, y: 450, width: 150, height: 15 });
            platforms.push({ x: 3400, y: 400, width: 150, height: 15 });
            // 5 vanliga fiender
            for (let i = 0; i < 5; i++) {
                spawnOneEnemy();
            }
        }
        // ======================================
        //  spawnOneEnemy()
        //  Skapar fiende (svart, grön, ev. annan) - ej boss
        // ======================================
        function spawnOneEnemy() {
            let x, y = 500;
            let minDist = 300;
            do {
                x = Math.random() * (WORLD_WIDTH - 32);
            } while (Math.abs(x - player.x) < minDist);
            let r = Math.random();
            let fiendeTyp;
            if (level >= 2 && r < 0.1) fiendeTyp = "greenblack";
            else if (r < 0.7) fiendeTyp = "black";
            else fiendeTyp = "green";
            let hp, dmg, sc, sp, col;
            let isBG = false; // black/green?
            // "black" => 10 HP, 5 poäng, skada=10
            // "green" => 10 HP, 5 poäng, skada=10 men färg=grön
            // "greenblack" => 50 HP, 20poäng, skada=10, col= "#00AA00" ex
            // (Du kan justera)
            if (fiendeTyp === "black") {
                hp = 10; dmg = 10; sc = 5; sp = 1.2; col = "#000000"; isBG = true;
            } else if (fiendeTyp === "green") {
                hp = 10; dmg = 10; sc = 5; sp = 1.2; col = "#00AA00"; isBG = true;
            } else {
                hp = 50; dmg = 10; sc = 20; sp = 1.4; col = "#006600"; isBG = true;
            }
            let e = {
                x: x, y: y, vx: 0, vy: 0,
                width: 32, height: 32,
                onGround: false,
                hp: hp,
                damage: dmg,
                scoreValue: sc,
                speed: sp,
                color: col,
                isBoss: false,
                isBlackOrGreen: isBG
            };
            enemies.push(e);
        }
        // ======================================
        //  spawnOneEnemyIfNotBoss(isBoss)
        //  Om boss => ingenting
        //  Om ej boss => spawnOneEnemy()
        // ======================================
        function spawnOneEnemyIfNotBoss(isBoss) {
            if (!isBoss) {
                spawnOneEnemy();
            }
        }
        // ======================================
        //  checkSpawnBoss()
        //  Om blackGreenKills >= 15 och boss ej spawnad => spawn boss
        // ======================================
        function checkSpawnBoss() {
            if (blackGreenKills >= 15 && !bossSpawned) {
                bossSpawned = true;
                spawnBoss();
            }
        }
        // ======================================
        //  spawnBoss()
        //  1000 HP, grön-svart-randig, studsar, isBoss=true
        // ======================================
        function spawnBoss() {
            let x, y = 500;
            let minDist = 300;
            do {
                x = Math.random() * (WORLD_WIDTH - 128);
            } while (Math.abs(x - player.x) < minDist);
            let boss = {
                x: x,
                y: y,
                width: 128,
                height: 128,
                vx: 0,
                vy: 0,
                onGround: false,
                hp: 1000,
                damage: 0, // kollision tar inte liv? Eg: sedan = -20 HP i code above
                // men "damage" används inte på boss-krock.
                scoreValue: 100, // stor belöning
                speed: 0.8,
                color: "#00FF00", // struntar i -> ritar randig
                isBoss: true,
                isBlackOrGreen: false // boss är speciell
            };
            enemies.push(boss);
        }
        // ======================================
        //  checkLevelUp()
        //  Om score >= 200*gällande level => +1 level
        //  Men i den här versionen byter vi level
        //  DIREKT om bossen dör. Fortfarande kollar vi
        //  om man inte dödade bossen men ändå nått 200?
        // ======================================
        function checkLevelUp() {
            while (score >= 200 * level) {
                level++;
                initLevel(level);
            }
        }
        // ======================================
        //  createDeathEffect(cx,cy,color,isBoss)
        // ======================================
        function createDeathEffect(cx, cy, color, isBoss) {
            let effect = {
                x: cx,
                y: cy,
                color: color || "#000000",
                radius: 0,
                growth: isBoss ? 2.5 : 1.5,
                alpha: 1.0,
                fadeSpeed: 0.02,
                circleCount: isBoss ? 14 : 6,
                isBoss: isBoss
            };
            deathEffects.push(effect);
        }
        // ======================================
        //  gameOver()
        // ======================================
        function gameOver() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            ctx.fillStyle = "#000000";
            ctx.font = "40px sans-serif";
            ctx.fillText("GAME OVER", CANVAS_WIDTH / 2 - 100, CANVAS_HEIGHT / 2 - 20);
            ctx.font = "30px sans-serif";
            ctx.fillText("Poäng: " + score, CANVAS_WIDTH / 2 - 70, CANVAS_HEIGHT / 2 + 20);
        }
        // ======================================
        //  Hjälpfunktioner för teckning
        // ======================================
        function drawCircle(x, y, r, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fill();
        }
        // En enkel "randig" cirkel kan ritas i spawnBoss() men
        // vi valde draw i "drawBoss"?
        // Men just nu ritar vi i draw() -> drawStripedCircle
        // ... men här förenklat -> se ex i tidigare kod.
        // Skippas i denna version => man kan expandera om man vill.
        function drawPlus(x, y, w, h, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x + w * 0.4, y, w * 0.2, h);
            ctx.fillRect(x, y + h * 0.4, w, h * 0.2);
        }
        // ======================================
        //  updateCamera()
        // ======================================
        function updateCamera() {
            cameraX = player.x - CANVAS_WIDTH / 2;
            if (cameraX < 0) cameraX = 0;
            if (cameraX > WORLD_WIDTH - CANVAS_WIDTH) {
                cameraX = WORLD_WIDTH - CANVAS_WIDTH;
            }
        }
        // ================
        //  KLAR
        // ================
    </script>
      }
    }
    // === Fienden skjuter en kula ===
    function shootEnemyBullet(enemy) {
      const bullet = new PIXI.Graphics();
      bullet.beginFill(0xff9900);
      bullet.drawCircle(0, 0, 5);
      bullet.endFill();
      bullet.x = enemy.x;
      bullet.y = enemy.y + 50; // Nedanför fienden
      app.stage.addChild(bullet);
      enemyBullets.push(bullet);
    }
    // === En enkel AABB-kollision (rektangel-approx) för Pixi Graphics ===
    function hitTest(a, b) {
      // Hämta bounds
      const ab = a.getBounds();
      const bb = b.getBounds();
      return ab.x + ab.width > bb.x &&
             ab.x < bb.x + bb.width &&
             ab.y + ab.height > bb.y &&
             ab.y < bb.y + bb.height;
    }
    // === Hantera Game Over ===
    function gameOver() {
      // Pausa spelet genom att stoppa ticker
      app.ticker.stop();
      // Visa en enkel "Game Over"-text
      const style = new PIXI.TextStyle({
        fill: "#ff0000",
        fontSize: 64,
        fontWeight: "bold"
      });
      const gameOverText = new PIXI.Text("GAME OVER", style);
      gameOverText.anchor.set(0.5);
      gameOverText.x = app.screen.width / 2;
      gameOverText.y = app.screen.height / 2;
      app.stage.addChild(gameOverText);
    }
    // === Gör att spelet skalar om ifall fönstret ändras ===
    window.addEventListener('resize', () => {
      app.renderer.resize(window.innerWidth, window.innerHeight);
      background.width = app.screen.width;
      background.height = app.screen.height;
    });
  </script>
</body>
</html>
